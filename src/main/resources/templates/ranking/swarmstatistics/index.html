<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{components/common::header}"></head>
<head>
    <style>
        /* Self Ranking Card Styles */
        .spk-ranking-self {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .spk-ranking-self__rank {
            text-align: center;
            padding: 1rem 2rem;
            background: #10b981;
            border-radius: 12px;
            color: white;
            min-width: 150px;
        }

        .spk-ranking-self__rank-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .spk-ranking-self__rank-value {
            font-size: 2.5rem;
            font-weight: bold;
            line-height: 1;
        }

        .spk-ranking-self__stats {
            flex: 1;
        }

        /* Ranking Table Styles */
        .spk-ranking-table-container {
            max-height: 800px;
            overflow-y: auto;
            border: 1px solid var(--spk-border-color);
            border-radius: var(--spk-radius);
            position: relative;
        }

        .spk-ranking-table {
            margin: 0;
            width: 100%;
            border-collapse: collapse;
        }

        .spk-ranking-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .spk-ranking-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 2px;
            background: rgba(0, 0, 0, 0.1);
        }

        .spk-ranking-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            padding: 1rem;
            border: none;
        }

        .spk-ranking-table th:first-child {
            border-top-left-radius: var(--spk-radius);
        }

        .spk-ranking-table th:last-child {
            border-top-right-radius: var(--spk-radius);
        }

        .spk-ranking-table td {
            text-align: center;
            vertical-align: middle;
            border: none;
        }

        .spk-ranking-row {
            transition: background-color 0.2s ease;
        }

        .spk-ranking-row:hover {
            background-color: #f8f9fa;
        }

        /* Top 3 Special Styling */
        .spk-ranking-row--top1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
        }

        .spk-ranking-row--top1:hover {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 215, 0, 0.1) 100%);
        }

        .spk-ranking-row--top2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15) 0%, rgba(192, 192, 192, 0.05) 100%);
        }

        .spk-ranking-row--top2:hover {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.25) 0%, rgba(192, 192, 192, 0.1) 100%);
        }

        .spk-ranking-row--top3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15) 0%, rgba(205, 127, 50, 0.05) 100%);
        }

        .spk-ranking-row--top3:hover {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.25) 0%, rgba(205, 127, 50, 0.1) 100%);
        }

        /* Banned & Privacy Styles */
        .spk-ranking-row--banned {
            background-color: rgba(239, 68, 68, 0.05);
        }

        .spk-ranking-row--banned .spk-ranking-user,
        .spk-ranking-row--banned .spk-ranking-traffic {
            opacity: 0.7;
        }

        .spk-ranking-row--privacy .spk-ranking-nickname {
            font-style: italic;
            color: var(--spk-text-muted);
        }

        .spk-ranking-avatar--placeholder {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--spk-text-muted);
            background-color: var(--spk-gray-200);
            border: 2px solid var(--spk-border-color);
        }

        .spk-ranking-avatar--privacy {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--spk-gray-200);
            color: var(--spk-text-muted);
            font-size: 1.2rem;
        }

        .spk-text-dashed {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .spk-badge--banned {
            background-color: var(--spk-danger);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            vertical-align: middle;
            font-weight: normal;
        }

        /* Ranking Medal Styles */
        .spk-ranking-rank {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .spk-ranking-medal {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .spk-ranking-medal i {
            font-size: 1.4rem;
        }

        .spk-ranking-medal--gold {
            color: #FFD700;
        }

        .spk-ranking-medal--silver {
            color: #C0C0C0;
        }

        .spk-ranking-medal--bronze {
            color: #CD7F32;
        }

        /* User Display */
        .spk-ranking-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: flex-start;
            text-align: left !important;
        }

        .spk-ranking-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
            background-color: #f0f0f0;
            transition: opacity 0.3s ease;
        }

        .spk-ranking-avatar[data-src] {
            opacity: 0.5;
        }

        .spk-ranking-avatar.loaded {
            opacity: 1;
        }

        .spk-ranking-nickname {
            font-weight: 500;
            color: #2d3748;
        }

        /* Traffic Display */
        .spk-ranking-traffic {
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            display: inline-block;
        }

        .spk-ranking-traffic--upload {
            background-color: #e8f4fd;
            color: #1e88e5;
        }

        .spk-ranking-traffic--download {
            background-color: #e8f5e9;
            color: #43a047;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .spk-ranking-self {
                flex-direction: column;
                gap: 1rem;
            }

            .spk-ranking-self__rank {
                width: 100%;
            }

            .spk-table-wrapper {
                overflow-x: auto;
            }

            .spk-ranking-table {
                font-size: 0.875rem;
            }

            .spk-ranking-avatar {
                width: 32px;
                height: 32px;
            }

            .spk-ranking-medal {
                font-size: 1rem;
            }

        .spk-ranking-medal i {
            font-size: 1.1rem;
        }
    }

    /* Dark Mode Adjustments */
    @media (prefers-color-scheme: dark) {
        .spk-ranking-self__rank {
            background: #059669;
        }

        .spk-ranking-nickname {
            color: var(--spk-text-primary);
        }

        .spk-ranking-traffic--upload {
            background-color: #1e3a8a;
            color: #93c5fd;
        }

        .spk-ranking-traffic--download {
            background-color: #065f46;
            color: #6ee7b7;
        }

        .spk-ranking-avatar {
            border-color: var(--spk-border-light);
            background-color: #374151;
        }

        .spk-ranking-table th {
            background-color: #374151;
        }

        .spk-ranking-table thead::after {
            background: rgba(255, 255, 255, 0.1);
        }

        .spk-ranking-table-container {
            border-color: var(--spk-border-color);
        }

        .spk-ranking-row--banned {
            background-color: rgba(239, 68, 68, 0.15);
        }
        .spk-ranking-avatar--placeholder {
            background-color: #374151;
            color: #9ca3af;
            border-color: #4b5563;
        }

        /* Custom scrollbar for dark mode */
        .spk-ranking-table-container::-webkit-scrollbar {
            width: 12px;
        }

        .spk-ranking-table-container::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .spk-ranking-table-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 6px;
        }

        .spk-ranking-table-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    }

    [data-theme="dark"] .spk-ranking-self__rank {
        background: #059669;
    }

    [data-theme="dark"] .spk-ranking-nickname {
        color: var(--spk-text-primary);
    }

    [data-theme="dark"] .spk-ranking-traffic--upload {
        background-color: #1e3a8a;
        color: #93c5fd;
    }

    [data-theme="dark"] .spk-ranking-traffic--download {
        background-color: #065f46;
        color: #6ee7b7;
    }

    [data-theme="dark"] .spk-ranking-avatar {
        border-color: var(--spk-border-light);
        background-color: #374151;
    }

    [data-theme="dark"] .spk-ranking-table th {
        background-color: #374151;
    }

    [data-theme="dark"] .spk-ranking-table thead::after {
        background: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .spk-ranking-table-container {
        border-color: var(--spk-border-color);
    }

    [data-theme="dark"] .spk-ranking-row--banned {
        background-color: rgba(239, 68, 68, 0.15);
    }

    [data-theme="dark"] .spk-ranking-avatar--placeholder {
        background-color: #374151;
        color: #9ca3af;
        border-color: #4b5563;
    }

    /* Custom scrollbar for dark mode */
    [data-theme="dark"] .spk-ranking-table-container::-webkit-scrollbar {
        width: 12px;
    }

    [data-theme="dark"] .spk-ranking-table-container::-webkit-scrollbar-track {
        background: #1f2937;
    }

    [data-theme="dark"] .spk-ranking-table-container::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 6px;
    }

    [data-theme="dark"] .spk-ranking-table-container::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
    }
</style>
</head>
<body class="spk-body">
<nav th:replace="~{components/common::navbar}"></nav>
<div th:replace="~{components/common::traffic-info-bar}"></div>

<header class="spk-page-header">
    <div class="spk-container spk-page-header__inner">
        <h1 class="spk-page-header__title">
            <i class="fas fa-trophy"></i> 数据贡献排行榜
        </h1>
    </div>
</header>

<main class="spk-main" style="padding-top: 0;">
    <div class="spk-container">
        <!-- User's Own Ranking Card -->
        <div class="spk-card spk-mb-4" th:if="${self != null}">
            <div class="spk-card__header">
                <h3 class="spk-card__title">
                    <i class="fas fa-user"></i> 我的排名
                </h3>
            </div>
            <div class="spk-card__body">
                <div class="spk-ranking-self">
                    <div class="spk-ranking-self__rank">
                        <div class="spk-ranking-self__rank-label">排名</div>
                        <div class="spk-ranking-self__rank-value" th:text="${self.rank > 1000 ? '>1000' : self.rank}">-</div>
                    </div>
                    <div class="spk-ranking-self__stats">
                        <div class="spk-row">
                            <div class="spk-col-3">
                                <div class="spk-stat">
                                    <div class="spk-stat__label">
                                        <i class="fas fa-upload"></i> 汇报上传
                                    </div>
                                    <div class="spk-stat__value" th:text="${unitConverter.formatSize(self.sentTrafficSelfReport)}">0 B</div>
                                </div>
                            </div>
                            <div class="spk-col-3">
                                <div class="spk-stat">
                                    <div class="spk-stat__label">
                                        <i class="fas fa-download"></i> 汇报下载
                                    </div>
                                    <div class="spk-stat__value" th:text="${unitConverter.formatSize(self.receivedTrafficSelfReport)}">0 B</div>
                                </div>
                            </div>
                            <div class="spk-col-3">
                                <div class="spk-stat">
                                    <div class="spk-stat__label">
                                        <i class="fas fa-check-circle"></i> 确认上传
                                    </div>
                                    <div class="spk-stat__value" th:text="${unitConverter.formatSize(self.sentTrafficOtherAck)}">0 B</div>
                                </div>
                            </div>
                            <div class="spk-col-3">
                                <div class="spk-stat">
                                    <div class="spk-stat__label">
                                        <i class="fas fa-check-circle"></i> 确认下载
                                    </div>
                                    <div class="spk-stat__value" th:text="${unitConverter.formatSize(self.receivedTrafficOtherAck)}">0 B</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Self Ranking Message -->
        <div class="spk-alert spk-alert--info spk-mb-4" th:if="${self == null}">
            <i class="fas fa-info-circle"></i> 您还没有统计数据，如果您是新注册用户或刚刚创建用户应用程序，数据可能需要一段时间才会显示。
        </div>

        <!-- Ranking Table Card -->
        <div class="spk-card">
            <div class="spk-card__header">
                <h3 class="spk-card__title">
                    <i class="fas fa-list-ol"></i> TOP 500
                    <small style="font-size: 0.6em; margin-left: 0.5rem; vertical-align: middle;"
                           data-toggle="tooltip"
                           title="已启用隐私模式的用户将以匿名形式展示">
                        <i class="fas fa-circle-info" style="color: var(--spk-text-muted); cursor: help;"></i>
                    </small>
                </h3>
            </div>
            <div class="spk-card__body">
                <!-- Empty State -->
                <div th:if="${data == null or data.isEmpty()}" class="spk-empty">
                    <i class="fas fa-trophy spk-empty__icon"></i>
                    <h4 class="spk-empty__title">暂无排名数据</h4>
                    <p class="spk-empty__text">当前还没有用户排名数据</p>
                </div>

                <!-- Ranking Table -->
                <div th:if="${data != null and !data.isEmpty()}" class="spk-ranking-table-container">
                    <table class="spk-table spk-ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">排名</th>
                                <th style="width: 200px; text-align: left;">用户</th>
                                <th>汇报上传</th>
                                <th>汇报下载</th>
                                <th>确认上传</th>
                                <th>确认下载</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="entry : ${data}"
                                th:class="(${entry.key.rank <= 3 ? 'spk-ranking-row spk-ranking-row--top' + entry.key.rank : 'spk-ranking-row'}) +
                                          (${entry.value.bannedAt != null ? ' spk-ranking-row--banned' : ''}) +
                                          (${entry.value.privacyMode ? ' spk-ranking-row--privacy' : ''})">
                                <td class="spk-ranking-rank">
                                    <span th:if="${entry.key.rank == 1}" class="spk-ranking-medal spk-ranking-medal--gold">
                                        <i class="fas fa-crown"></i>
                                        <span th:text="${entry.key.rank}">1</span>
                                    </span>
                                    <span th:if="${entry.key.rank == 2}" class="spk-ranking-medal spk-ranking-medal--silver">
                                        <i class="fas fa-medal"></i>
                                        <span th:text="${entry.key.rank}">2</span>
                                    </span>
                                    <span th:if="${entry.key.rank == 3}" class="spk-ranking-medal spk-ranking-medal--bronze">
                                        <i class="fas fa-medal"></i>
                                        <span th:text="${entry.key.rank}">3</span>
                                    </span>
                                    <span th:if="${entry.key.rank > 3}" th:text="${entry.key.rank}">4</span>
                                </td>
                                <td class="spk-ranking-user">
<!--                                    <img th:if="${!entry.value.privacyMode}"-->
<!--                                         loading="lazy"-->
<!--                                         th:src="${entry.value.avatar}"-->
<!--                                         th:alt="${entry.value.nickname}"-->
<!--                                         class="spk-ranking-avatar">-->
                                    <div th:if="${entry.value.privacyMode || entry.value.bannedAt != null}" class="spk-ranking-avatar spk-ranking-avatar--placeholder">
                                         <i class="fas fa-user-secret"></i>
                                    </div>

                                    <div style="display: inline-block;">
                                        <span th:if="${!entry.value.privacyMode}"
                                              class="spk-ranking-nickname"
                                              th:classappend="${entry.value.bannedAt != null ? 'spk-text-dashed' : ''}"
                                              th:text="${#strings.length(entry.value.nickname) <= 3 ?
                                                        #strings.repeat('*', #strings.length(entry.value.nickname)) :
                                                        #strings.substring(entry.value.nickname, 0, 3) + #strings.repeat('*', #strings.length(entry.value.nickname) - 3)}"
                                              th:title="${entry.value.bannedAt == null ? '隐私保护：用户名已脱敏' : ''}"
                                              >昵称</span>
                                        <span th:if="${entry.value.privacyMode && entry.value.bannedAt == null} " class="spk-ranking-nickname">匿名用户</span>
                                        <span th:if="${entry.value.privacyMode && entry.value.bannedAt != null}" class="spk-ranking-nickname">用户已封禁</span>

                                        <span th:if="${entry.value.bannedAt != null}" class="spk-badge--banned"
                                              data-toggle="tooltip"
                                              title="该用户已被封禁">
                                            已封禁
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="spk-ranking-traffic spk-ranking-traffic--upload"
                                          th:text="${unitConverter.formatSize(entry.key.sentTrafficSelfReport)}">0 B</span>
                                </td>
                                <td>
                                    <span class="spk-ranking-traffic spk-ranking-traffic--download"
                                          th:text="${unitConverter.formatSize(entry.key.receivedTrafficSelfReport)}">0 B</span>
                                </td>
                                <td>
                                    <span class="spk-ranking-traffic spk-ranking-traffic--upload"
                                          th:text="${unitConverter.formatSize(entry.key.sentTrafficOtherAck)}">0 B</span>
                                </td>
                                <td>
                                    <span class="spk-ranking-traffic spk-ranking-traffic--download"
                                          th:text="${unitConverter.formatSize(entry.key.receivedTrafficOtherAck)}">0 B</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{components/common::footer}"></div>


</body>
</html>

