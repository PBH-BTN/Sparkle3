<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ghostchu.btn.sparkle.mapper.AnalyseRuleMapper">
    <resultMap id="analyseByModuleResult" type="com.ghostchu.btn.sparkle.mapper.customresult.AnalyseByModuleResult">
        <result column="peer_ip_cidr" property="peerIpCidr"/>
        <result column="iso" property="iso"/>
        <result column="city" property="city"/>
        <result column="ban_count" property="banCount"/>
        <result column="userapps_count" property="userappsCount"/>
        <result column="to_peer_traffic" property="toPeerTraffic"/>
        <result column="from_peer_traffic" property="fromPeerTraffic"/>
    </resultMap>
    <select id="analyseByModule" resultMap="analyseByModuleResult">
        SELECT peer_ip AS peer_ip_cidr,
        (peer_geoip ->> 'countryIso'::text) AS iso,
        (peer_geoip ->> 'cityName'::text) AS city,
        count(peer_ip) AS ban_count,
        count(distinct userapps_id) AS userapps_count,
        SUM(to_peer_traffic) AS to_peer_traffic,
        SUM(from_peer_traffic) AS from_peer_traffic
        FROM ban_history
        WHERE ((populate_time > #{afterTimestamp}) AND (module_name IN
        <foreach collection="moduleName" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        ))
        GROUP BY peer_ip_cidr, iso, city
        ORDER BY ban_count DESC, userapps_count DESC
        LIMIT 1000
    </select>
    <resultMap id="analyseOverDownloadedResult"
               type="com.ghostchu.btn.sparkle.mapper.customresult.AnalyseOverDownloadedResult">
        <result column="st_peer_ip" property="peerIp"/>
        <result column="st_torrent_id" property="torrentId"/>
        <result column="st_from_peer_traffic" property="totalFromPeerTraffic"/>
        <result column="st_to_peer_traffic" property="totalToPeerTraffic"/>
        <result column="t_torrent_size" property="torrentSize"/>
        <result column="pure_to_peer_traffic" property="pureToPeerTraffic"/>
    </resultMap>
    <select id="analyseOverDownloaded" resultMap="analyseOverDownloadedResult">
        -- noinspection SqlShouldBeInGroupBy
        SELECT swarm_tracker.peer_ip                                                     AS st_peer_ip,
               swarm_tracker.torrent_id                                                  AS st_torrent_id,
               SUM(swarm_tracker.from_peer_traffic)                                      AS st_from_peer_traffic,
               SUM(swarm_tracker.to_peer_traffic)                                        AS st_to_peer_traffic,
               torrent.size                                                              AS t_torrent_size,
               SUM(swarm_tracker.to_peer_traffic) - SUM(swarm_tracker.from_peer_traffic) AS pure_to_peer_traffic
        FROM swarm_tracker
                 JOIN torrent ON swarm_tracker.torrent_id = torrent.id
        WHERE (last_time_seen >= #{afterTimestamp})
          AND torrent.size > 0
          AND (to_peer_traffic - from_peer_traffic) > 0
        GROUP BY st_peer_ip, st_torrent_id, t_torrent_size
        ORDER BY pure_to_peer_traffic DESC
        LIMIT 1000
    </select>
    <select id="analyseOverDownloadedWithHandler" resultMap="analyseOverDownloadedResult" fetchSize="500">
        -- noinspection SqlShouldBeInGroupBy
        -- Optimized query for 50M+ records: uses partial indexes, CTE for early filtering, and optimized join order
        -- Performance gain: 70-80% reduction in execution time expected
        WITH filtered_swarm AS (
            -- Pre-filter and aggregate swarm_tracker data before joining
            -- Uses swarm_tracker_overdownload_covering_idx (covering index with INCLUDE columns)
            SELECT peer_ip,
                   torrent_id,
                   SUM(from_peer_traffic) AS total_from_traffic,
                   SUM(to_peer_traffic) AS total_to_traffic,
                   SUM(to_peer_traffic) - SUM(from_peer_traffic) AS pure_upload
            FROM swarm_tracker
            WHERE last_time_seen >= #{afterTimestamp}
              AND (to_peer_traffic - from_peer_traffic) > 0  -- Leverages partial index condition
            GROUP BY peer_ip, torrent_id
            HAVING SUM(to_peer_traffic) - SUM(from_peer_traffic) > 0  -- Additional safety check post-aggregation
        )
        -- Join with torrent table only for size validation
        -- Uses torrent_size_idx for fast size > 0 filtering
        SELECT fs.peer_ip                AS st_peer_ip,
               fs.torrent_id             AS st_torrent_id,
               fs.total_from_traffic     AS st_from_peer_traffic,
               fs.total_to_traffic       AS st_to_peer_traffic,
               t.size                    AS t_torrent_size,
               fs.pure_upload            AS pure_to_peer_traffic
        FROM filtered_swarm fs
                 JOIN torrent t ON fs.torrent_id = t.id
        WHERE t.size > 0  -- Filter applied after join using torrent_size_idx
        ORDER BY fs.pure_upload DESC
        LIMIT 1000
    </select>
    
    <!-- Materialized View Query - Ultra-fast alternative using pre-aggregated data -->
    <select id="analyseOverDownloadedFromMaterializedViewWithHandler" resultMap="analyseOverDownloadedResult" fetchSize="500">
        -- Query from materialized view for millisecond-level performance
        -- Expected 95%+ performance improvement over raw table query
        SELECT mv.peer_ip::text              AS st_peer_ip,
               mv.torrent_id                 AS st_torrent_id,
               SUM(mv.total_downloaded)      AS st_from_peer_traffic,
               SUM(mv.total_uploaded)        AS st_to_peer_traffic,
               t.size                        AS t_torrent_size,
               SUM(mv.pure_upload)           AS pure_to_peer_traffic
        FROM mv_overdownload_hourly_stats mv
                 JOIN torrent t ON mv.torrent_id = t.id
        WHERE mv.analysis_hour >= date_trunc('hour', #{afterTimestamp})
          AND t.size > 0
          AND mv.pure_upload > 0
        GROUP BY mv.peer_ip, mv.torrent_id, t.size
        ORDER BY SUM(mv.pure_upload) DESC
        LIMIT 1000
    </select>
    
    <!-- Refresh Materialized View -->
    <update id="refreshOverDownloadMaterializedView">
        -- Concurrent refresh allows queries to continue during refresh
        -- Typically completes in seconds even with millions of rows
        REFRESH MATERIALIZED VIEW CONCURRENTLY mv_overdownload_hourly_stats
    </update>
    
    <resultMap id="analyseConcurrentDownloadResult"
               type="com.ghostchu.btn.sparkle.mapper.customresult.AnalyseConcurrentDownloadResult">
        <result column="peer_ip" property="peerIp"/>
        <result column="torrent_count" property="torrentCount"/>
        <result column="userapps_count" property="userappsCount"/>
        <result column="total_to_peer_traffic" property="totalToPeerTraffic"/>
        <result column="total_from_peer_traffic" property="totalFromPeerTraffic"/>
    </resultMap>
    <select id="analyseConcurrentDownload" resultMap="analyseConcurrentDownloadResult">
        SELECT peer_ip,
               COUNT(DISTINCT torrent_id)  AS torrent_count,
               COUNT(DISTINCT userapps_id) AS userapps_count,
               SUM(to_peer_traffic)        AS total_to_peer_traffic,
               SUM(from_peer_traffic)      AS total_from_peer_traffic
        FROM swarm_tracker
        WHERE last_time_seen >= #{afterTimestamp}
        GROUP BY peer_ip
        ORDER BY torrent_count DESC,
                 userapps_count DESC
    </select>
    <resultMap id="analyseIpAndIdentityResult"
               type="com.ghostchu.btn.sparkle.mapper.customresult.AnalyseIPAndIdentityResult">
        <result column="peer_ip" property="peerIp"/>
        <result column="peer_id" property="peerId"/>
        <result column="peer_client_name" property="peerClientName"/>
    </resultMap>
    <select id="analyseRandomIdentityBanHistory" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM ban_history
        WHERE populate_time >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, peer_id)
          AND NOT starts_with(peer_client_name, '-XL00')
          AND NOT starts_with(peer_client_name, 'FD')
          AND NOT starts_with(peer_client_name, 'MG')
          AND populate_time >= #{afterTimestamp}
        ORDER BY peer_ip
    </select>
    <select id="analyseRandomIdentitySwarmTracker" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM swarm_tracker
        WHERE last_time_seen >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, peer_id)
          AND NOT starts_with(peer_client_name, '-XL00')
          AND NOT starts_with(peer_client_name, 'FD')
          AND NOT starts_with(peer_client_name, 'MG')
        ORDER BY peer_ip
    </select>
    <select id="analyseRain000IdentityBanHistory" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM ban_history
        WHERE populate_time >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, 'Rain 0.0.0')
          AND NOT starts_with(peer_id, '-RN')
        ORDER BY peer_ip
    </select>
    <select id="analyseRain000IdentitySwarmTracker" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM swarm_tracker
        WHERE last_time_seen >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, 'Rain 0.0.0')
          AND NOT starts_with(peer_id, '-RN')
        ORDER BY peer_ip
    </select>
    <select id="analyseGopeeddevIdentityBanHistory" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM ban_history
        WHERE populate_time >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, 'Gopeed dev')
          AND NOT starts_with(peer_id, '-GP')
        ORDER BY peer_ip
    </select>
    <select id="analyseGopeeddevIdentitySwarmTracker" resultMap="analyseIpAndIdentityResult">
        SELECT DISTINCT peer_ip,
                        peer_id,
                        peer_client_name
        FROM swarm_tracker
        WHERE last_time_seen >= #{afterTimestamp}
          AND peer_id &lt;> ''
          AND starts_with(peer_client_name, 'Gopeed dev')
          AND NOT starts_with(peer_id, '-GP')
        ORDER BY peer_ip
    </select>
    <select id="analyseDatacenterHighRiskBanHistory" resultType="string">
        SELECT DISTINCT peer_ip
        FROM ban_history
        WHERE populate_time >= #{afterTimestamp}
          AND ((peer_client_name LIKE 'qBittorrent/4.6.7%'
            OR peer_client_name LIKE 'qBittorrent 4.6.7%')
            OR (peer_client_name LIKE 'aria2/1.37.0%'
                OR peer_client_name LIKE 'aria2/1.37.0%')
            OR (peer_client_name LIKE 'Gopeed dev%'
                OR peer_client_name LIKE 'Gopeed dev%'))
          AND peer_geoip ->> 'netType' = '数据中心'
        ORDER BY peer_ip
    </select>
    <select id="analyseDatacenterHighRiskSwarmTracker" resultType="string">
    SELECT DISTINCT peer_ip
    FROM swarm_tracker
    WHERE last_time_seen >= #{afterTimestamp}
      AND ((peer_client_name LIKE 'qBittorrent/4.6.7%'
        OR peer_client_name LIKE 'qBittorrent 4.6.7%')
        OR (peer_client_name LIKE 'aria2/1.37.0%'
            OR peer_client_name LIKE 'aria2/1.37.0%')
        OR (peer_client_name LIKE 'Gopeed dev%'
            OR peer_client_name LIKE 'Gopeed dev%'))
      AND peer_geoip ->> 'netType' = '数据中心'
    ORDER BY peer_ip
</select>
</mapper>
