<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ghostchu.btn.sparkle.mapper.UserSwarmStatisticMapper">
    <resultMap id="userSwarmStatisticTrackRankingDtoResultMap" type="com.ghostchu.btn.sparkle.service.dto.UserSwarmStatisticTrackRankingDto">
        <result property="rank" column="rank"/>
        <result property="userId" column="user_id"/>
        <result property="sentTrafficSelfReport" column="sent_traffic_self_report"/>
        <result property="sentTrafficOtherAck" column="sent_traffic_other_ack"/>
        <result property="receivedTrafficOtherAck" column="received_traffic_other_ack"/>
        <result property="receivedTrafficSelfReport" column="received_traffic_self_report"/>
    </resultMap>

    <insert id="updateAllUserSwarmStatistics">
        WITH self_report_stats AS (
            SELECT
                ua.user_id,
                COALESCE(SUM(st.to_peer_traffic), 0) as sent_self,
                COALESCE(SUM(st.from_peer_traffic), 0) as recv_self
            FROM userapp ua
            JOIN swarm_tracker st ON st.userapps_id = ua.id
            WHERE st.first_time_seen &gt;= #{startAt}
              AND st.last_time_seen &lt;= #{endAt}
            GROUP BY ua.user_id
        ),
        distinct_ips AS (
            SELECT DISTINCT ua.user_id, uah.ip
            FROM userapp ua
            JOIN userapps_heartbeat uah ON uah.userapp_id = ua.id
            WHERE uah.last_seen_at &gt;= #{startAt}
              AND uah.first_seen_at &lt;= #{endAt}
        ),
        other_ack_stats AS (
            SELECT
                di.user_id,
                COALESCE(SUM(st.from_peer_traffic), 0) as sent_other,
                COALESCE(SUM(st.to_peer_traffic), 0) as recv_other
            FROM distinct_ips di
            JOIN swarm_tracker st ON st.peer_ip &lt;&lt;= di.ip::inet
            WHERE st.first_time_seen &gt;= #{startAt}
              AND st.last_time_seen &lt;= #{endAt}
            GROUP BY di.user_id
        )
        INSERT INTO user_swarm_statistic (user_id, sent_traffic_other_ack, received_traffic_other_ack, sent_traffic_self_report, received_traffic_self_report, last_update_at)
        SELECT
            u.id,
            COALESCE(o.sent_other, 0),
            COALESCE(o.recv_other, 0),
            COALESCE(s.sent_self, 0),
            COALESCE(s.recv_self, 0),
            NOW()
        FROM "user" u
        LEFT JOIN self_report_stats s ON s.user_id = u.id
        LEFT JOIN other_ack_stats o ON o.user_id = u.id
        ON CONFLICT (user_id) DO UPDATE
        SET
            sent_traffic_other_ack = EXCLUDED.sent_traffic_other_ack,
            received_traffic_other_ack = EXCLUDED.received_traffic_other_ack,
            sent_traffic_self_report = EXCLUDED.sent_traffic_self_report,
            received_traffic_self_report = EXCLUDED.received_traffic_self_report,
            last_update_at = EXCLUDED.last_update_at
    </insert>

    <select id="calcUsersRanking" resultMap="userSwarmStatisticTrackRankingDtoResultMap">
        SELECT
            user_id,
            sent_traffic_self_report,
            sent_traffic_other_ack,
            received_traffic_other_ack,
            received_traffic_self_report,
            RANK() OVER (
                ORDER BY (
                    (sent_traffic_other_ack * #{sentTrafficOtherAckWeight}) +
                    (sent_traffic_self_report * #{sentTrafficSelfReportWeight}) +
                    (received_traffic_other_ack * #{receivedTrafficOtherAckWeight}) +
                    (received_traffic_self_report * #{receivedTrafficSelfReportWeight})
                    ) DESC
                ) AS rank
        FROM user_swarm_statistic
        <if test="ignoreUserIds != null and ignoreUserIds.size() > 0">
            WHERE user_id NOT IN
            <foreach item="ignoreUid" collection="ignoreUserIds" open="(" separator="," close=")">
                #{ignoreUid}
            </foreach>
        </if>
    </select>

    <select id="calcUserRanking" resultMap="userSwarmStatisticTrackRankingDtoResultMap">
        WITH UserRanks AS (
            SELECT
                user_id,
                sent_traffic_self_report,
                sent_traffic_other_ack,
                received_traffic_other_ack,
                received_traffic_self_report,
                RANK() OVER (
                    ORDER BY (
                        (sent_traffic_other_ack * #{sentTrafficOtherAckWeight}) +
                        (sent_traffic_self_report * #{sentTrafficSelfReportWeight}) +
                        (received_traffic_other_ack * #{receivedTrafficOtherAckWeight}) +
                        (received_traffic_self_report * #{receivedTrafficSelfReportWeight})
                        ) DESC
                    ) AS rank
            FROM user_swarm_statistic
            <if test="ignoreUserIds != null and ignoreUserIds.size() > 0">
                WHERE user_id NOT IN
                <foreach item="ignoreUid" collection="ignoreUserIds" open="(" separator="," close=")">
                    #{ignoreUid}
                </foreach>
            </if>
        )
        SELECT * FROM UserRanks
        WHERE user_id = #{userId}
        LIMIT 1;
    </select>
</mapper>
